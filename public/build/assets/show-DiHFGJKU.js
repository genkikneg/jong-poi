import{r as g,j as e,H as Y,F as A,a as Z}from"./app-DhMxmlnQ.js";import{b as U,B as x,a as N}from"./app-logo-icon-X3GIZxfD.js";import{H as ee}from"./heading-hZ5llr03.js";import{I as E}from"./input-error-MMwtQsxQ.js";import{C as v,a as y,b as k,d as I,c as w}from"./card-DxlLJTeC.js";import{I as se}from"./input-BYI6z9RA.js";import{L as M}from"./label-DLSaM3DW.js";import{A as ae,a as H,b as R,c as B}from"./app-layout-CNfg1OHM.js";import{d as V,b as re,s as te}from"./index-eH4SHpJj.js";/* empty css            */import"./index-B-t1sK0C.js";import"./index-CLgheG93.js";import"./index-DtzRoMoA.js";const ne=[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]],ie=U("ChevronDown",ne),q=new Intl.DateTimeFormat(void 0,{dateStyle:"medium",timeStyle:"short"}),S={default:{container:"bg-card border-border",badge:"bg-muted text-muted-foreground",text:"text-foreground"},1:{container:"bg-amber-50 border-amber-200",badge:"bg-amber-500/15 text-amber-800",text:"text-amber-800"},2:{container:"bg-sky-50 border-sky-200",badge:"bg-sky-500/15 text-sky-800",text:"text-sky-800"},3:{container:"bg-emerald-50 border-emerald-200",badge:"bg-emerald-500/15 text-emerald-800",text:"text-emerald-800"},4:{container:"bg-purple-50 border-purple-200",badge:"bg-purple-500/15 text-purple-800",text:"text-purple-800"}},l=r=>{if(r){const d=String(r);if(d in S)return S[d]}return S.default},le=r=>[{title:"セッション詳細",href:te(r.id).url}];function ye({session:r,totals:d,currentUserId:p,draft:n}){const C=r.status==="closed",z=Array.from({length:r.player_count},(s,a)=>a+1),c=r.owner_id===p,i=n?.entries??r.members.map(s=>({user_id:s.id,name:s.name,avatar:s.avatar,final_score:null,rank:null,submitted_at:null})),D=i.filter(s=>s.final_score!==null).length,u=i.find(s=>s.user_id===p),o=i.length===r.player_count&&D===r.player_count,F=new Map,O=[...d].map(s=>({...s,numericPoints:Number(s.points)})).sort((s,a)=>a.numericPoints-s.numericPoints);let f=null,_=0;O.forEach((s,a)=>{(f===null||s.numericPoints!==f)&&(_=a+1,f=s.numericPoints),F.set(s.user_id,_)});const G=Number(r.rules.base)*r.player_count,h=i.reduce((s,a)=>s+(a.final_score?Number(a.final_score):0),0)-G,b=!!(n&&o&&Math.abs(h)>1),J=Math.abs(h).toLocaleString(),K=h>0?"多い":"少ない",[Q,L]=g.useState(!1),[T,j]=g.useState(!1),W=()=>{!n||!c||b||!o||(L(!0),Z.post(V.confirm.url(r.id),{},{preserveScroll:!0,onFinish:()=>L(!1)}))},P=!n||!c||!o||b||Q,X=async()=>{try{await navigator.clipboard?.writeText(r.join_code),j(!0),setTimeout(()=>j(!1),2e3)}catch{j(!1)}},$=g.useMemo(()=>s=>s.split(" ").map(a=>a.trim()[0]).join("").toUpperCase(),[]),m=(s,a="md",t)=>e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsxs(H,{className:a==="sm"?"h-7 w-7":"h-9 w-9",children:[t&&e.jsx(R,{src:t,alt:s}),e.jsx(B,{children:$(s)})]}),e.jsx("span",{children:s})]});return e.jsxs(ae,{breadcrumbs:le(r),children:[e.jsx(Y,{title:r.name?`${r.name} | セッション`:"セッション詳細"}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(ee,{title:r.name||"セッション詳細",description:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("span",{children:["参加コード:"," ",e.jsx("span",{className:"font-mono text-base tracking-wider",children:r.join_code})]}),e.jsx(x,{type:"button",variant:"outline",size:"sm",onClick:X,className:N("border-dashed",T&&"border-primary text-primary"),children:T?"コピー済み":"コピー"})]})}),!C&&e.jsxs(v,{children:[e.jsxs(y,{children:[e.jsx(k,{children:"半荘結果を入力"}),e.jsxs(I,{children:["各自が自分の最終持ち点を入力し、ホストが全員分を確認して確定します。",i.length>0&&e.jsxs("span",{className:"ml-2 text-xs",children:["現在 ",D,"/",r.player_count," 人が入力済み"]})]})]}),e.jsxs(w,{className:"space-y-8",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-muted-foreground",children:"自分のスコア"}),e.jsx(A,{...V.store.form(r.id),className:"space-y-4",children:({processing:s,errors:a})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row",children:[e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(M,{htmlFor:"final_score",children:"最終持ち点"}),e.jsx(se,{id:"final_score",name:"final_score",type:"number",step:"100",required:!0,defaultValue:u?.final_score??""}),e.jsx(E,{message:a.final_score})]}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(M,{htmlFor:"rank",children:"最終順位（任意）"}),e.jsxs("select",{id:"rank",name:"rank",defaultValue:u?.rank?.toString()??"",className:"w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"自動判定"}),z.map(t=>e.jsxs("option",{value:t,children:[t,"位"]},t))]}),e.jsx(E,{message:a.rank})]})]}),e.jsxs("div",{className:"flex flex-wrap justify-end gap-2",children:[e.jsx(x,{type:"submit",disabled:s,children:u?.final_score?"更新する":"送信する"}),c&&n&&e.jsx(x,{type:"button",variant:"outline",disabled:P,onClick:W,className:N("border-2",P?"border-border":"border-primary text-primary shadow-[0_0_0_1px_rgba(59,130,246,0.4)] hover:bg-primary/5"),children:"全員分を確定する"})]}),c&&n&&!o&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"全員の入力が揃うまで確定できません。"})]})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-muted-foreground",children:"入力状況"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:i.map(s=>e.jsxs("div",{className:`flex items-center justify-between rounded-lg border px-3 py-2 ${s.final_score?"bg-emerald-50 border-emerald-200":"bg-card border-border"}`,children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium",children:[m(s.name,"sm",s.avatar),s.user_id===p&&e.jsx("span",{className:"ml-2 text-xs text-primary",children:"(自分)"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.final_score?`${Number(s.final_score).toLocaleString()} 点`:"未入力"})]}),e.jsx("div",{className:"text-sm font-semibold text-muted-foreground",children:s.rank?`${s.rank}位`:""})]},s.user_id))}),b&&e.jsxs("p",{className:"text-sm text-amber-700",children:["現在 ",K==="多い"?"+":"-",J," 点。入力を修正してください。"]})]})]})]}),e.jsxs(v,{children:[e.jsxs(y,{children:[e.jsx(k,{children:"合計ポイント"}),e.jsx(I,{children:"半荘の合計。加算順序に関わらず同じ計算式です。"})]}),e.jsx(w,{className:"grid gap-4 md:grid-cols-2",children:d.map(s=>{const a=F.get(s.user_id)??null,t=l(a);return e.jsxs("div",{className:`rounded-lg border px-4 py-3 transition-colors ${t.container}`,children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("div",{className:"text-muted-foreground",children:m(s.name,"sm",s.avatar)}),a&&e.jsxs("span",{className:`rounded-full px-2 py-0.5 text-xs font-semibold ${t.badge}`,children:["第",a,"位"]})]}),e.jsx("p",{className:`text-2xl font-semibold ${t.text}`,children:Number(s.points).toLocaleString(void 0,{maximumFractionDigits:0,minimumFractionDigits:0})})]},s.user_id)})})]}),r.games.length>0&&e.jsxs(v,{children:[e.jsx(y,{children:e.jsx(k,{children:"半荘履歴"})}),e.jsx(w,{className:"space-y-4",children:r.games.map(s=>e.jsxs("div",{className:"rounded-xl border p-4",children:[e.jsxs("div",{className:"hidden md:block",children:[e.jsxs("div",{className:"flex flex-col gap-1 text-sm text-muted-foreground md:flex-row md:items-center md:justify-between",children:[e.jsxs("span",{children:["第",s.ordinal,"回"]}),e.jsx("span",{children:s.played_at?q.format(new Date(s.played_at)):"日時未入力"})]}),e.jsx("div",{className:"mt-3 grid gap-2 md:grid-cols-4",children:s.results.map(a=>e.jsxs("div",{className:`rounded-lg border px-3 py-2 ${l(a.rank).container}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-medium",children:m(a.user.name,"sm",a.user.avatar)}),e.jsx("span",{className:`rounded-full px-2 py-0.5 text-xs font-semibold ${l(a.rank).badge}`,children:a.rank?`第${a.rank}位`:"順位未入力"})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[Number(a.final_score).toLocaleString()," 点"]}),e.jsx("p",{className:"text-lg font-semibold text-black",children:Number(a.points).toLocaleString(void 0,{maximumFractionDigits:0,minimumFractionDigits:0})})]},a.id))})]}),e.jsx("div",{className:"md:hidden",children:e.jsxs("details",{className:"group",children:[e.jsxs("summary",{className:"flex cursor-pointer list-none flex-col gap-3 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"font-medium",children:["第",s.ordinal,"回"]}),e.jsxs("span",{className:"flex items-center gap-2",children:[s.played_at?q.format(new Date(s.played_at)):"日時未入力",e.jsx(ie,{className:"size-4 transition-transform group-open:rotate-180"})]})]}),e.jsx("div",{className:"flex flex-wrap gap-3",children:s.results.map(a=>e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:N("flex h-[2.3rem] w-[2.3rem] items-center justify-center rounded-full border text-base font-semibold",l(a.rank).badge),children:a.rank??"-"}),e.jsxs(H,{className:"absolute bottom-0 right-0 h-[1.9rem] w-[1.9rem] translate-x-[35%] translate-y-[35%] border-2 border-background shadow",children:[a.user.avatar&&e.jsx(R,{src:a.user.avatar,alt:a.user.name}),e.jsx(B,{children:$(a.user.name)})]})]},`summary-${a.id}`))})]}),e.jsx("div",{className:"mt-3 space-y-2",children:s.results.map(a=>e.jsxs("div",{className:`rounded-lg border px-3 py-2 ${l(a.rank).container}`,children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("div",{className:"font-medium",children:m(a.user.name,"sm",a.user.avatar)}),e.jsx("span",{className:`rounded-full px-2 py-0.5 text-xs font-semibold ${l(a.rank).badge}`,children:a.rank?`第${a.rank}位`:"順位未入力"})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[Number(a.final_score).toLocaleString()," 点"]}),e.jsxs("p",{className:"text-base font-semibold text-black",children:[Number(a.points).toLocaleString(void 0,{maximumFractionDigits:0,minimumFractionDigits:0}),"pt"]})]},a.id))})]})})]},s.id))})]}),!C&&e.jsx(A,{...re.form(r.id),children:({processing:s})=>e.jsx(x,{type:"submit",variant:"destructive",disabled:s,children:"セッションを終了する"})})]})]})}export{ye as default};
